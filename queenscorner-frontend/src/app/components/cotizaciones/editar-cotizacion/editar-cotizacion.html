<div class="form-container">
  <div class="form-card">
    <div *ngIf="cargando" class="loading-center">
      <div class="spinner"></div>
      <p>Cargando cotizaci√≥n...</p>
    </div>

    <div *ngIf="!cargando">
      <h1>Editar Cotizaci√≥n</h1>
      <p class="subtitle">Actualiza los datos de la cotizaci√≥n</p>

      <form (ngSubmit)="guardar()" class="formulario">
        <!-- Datos principales -->
        <div class="seccion">
          <h3>Informaci√≥n General</h3>

          <div class="form-group">
            <label for="cliente">Cliente *</label>
            <select
              id="cliente"
              [(ngModel)]="cotizacion.clienteId"
              name="clienteId"
              [disabled]="loading || cargandoClientes"
              required>
              <option value="">Selecciona un cliente</option>
              <option *ngFor="let cliente of clientes" [value]="cliente.id">
                {{ cliente.nombre }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="descripcion">Descripci√≥n *</label>
            <textarea
              id="descripcion"
              [(ngModel)]="cotizacion.descripcion"
              name="descripcion"
              placeholder="Descripci√≥n general de la cotizaci√≥n"
              [disabled]="loading"
              rows="2"
              required></textarea>
          </div>

          <div class="form-group">
            <label for="fechaValidez">Fecha de Validez *</label>
            <input
              id="fechaValidez"
              type="date"
              [(ngModel)]="cotizacion.fechaValidez"
              name="fechaValidez"
              [disabled]="loading"
              required>
          </div>

          <div class="form-group">
            <label for="observaciones">Observaciones</label>
            <textarea
              id="observaciones"
              [(ngModel)]="cotizacion.observaciones"
              name="observaciones"
              placeholder="Notas adicionales (opcional)"
              [disabled]="loading"
              rows="2"></textarea>
          </div>
        </div>

        <!-- Items de cotizaci√≥n -->
        <div class="seccion">
          <h3>Items de Cotizaci√≥n</h3>

          <div class="items-input">
            <div class="form-group">
              <label for="itemDesc">Descripci√≥n</label>
              <input
                id="itemDesc"
                type="text"
                [(ngModel)]="nuevoItem.descripcion"
                name="itemDescripcion"
                placeholder="Ej: Dise√±o gr√°fico"
                [disabled]="loading">
            </div>

            <div class="form-group">
              <label for="itemCant">Cantidad</label>
              <input
                id="itemCant"
                type="number"
                [(ngModel)]="nuevoItem.cantidad"
                name="itemCantidad"
                min="1"
                [disabled]="loading">
            </div>

            <div class="form-group">
              <label for="itemPrecio">Precio Unitario</label>
              <input
                id="itemPrecio"
                type="number"
                [(ngModel)]="nuevoItem.precioUnitario"
                name="itemPrecio"
                min="0"
                step="0.01"
                [disabled]="loading">
            </div>

            <button type="button" class="btn btn-add" (click)="agregarItem()" [disabled]="loading">
              + Agregar
            </button>
          </div>

          <div *ngIf="cotizacion.items.length > 0" class="items-table">
            <table>
              <thead>
                <tr>
                  <th>Descripci√≥n</th>
                  <th>Cantidad</th>
                  <th>Precio Unit.</th>
                  <th>Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of cotizacion.items; let i = index">
                  <td>{{ item.descripcion }}</td>
                  <td class="center">{{ item.cantidad }}</td>
                  <td class="right">${{ item.precioUnitario | number: '1.2-2' }}</td>
                  <td class="right">${{ item.subtotal | number: '1.2-2' }}</td>
                  <td class="center">
                    <button type="button" class="btn-remove" (click)="eliminarItem(i)" [disabled]="loading">
                      ‚úï
                    </button>
                  </td>
                </tr>
                <tr class="total-row">
                  <td colspan="3" class="right"><strong>Subtotal:</strong></td>
                  <td class="right"><strong>${{ getSubtotal() | number: '1.2-2' }}</strong></td>
                  <td></td>
                </tr>
                <tr class="total-row">
                  <td colspan="3" class="right"><strong>Impuestos (19%):</strong></td>
                  <td class="right"><strong>${{ getImpuestos() | number: '1.2-2' }}</strong></td>
                  <td></td>
                </tr>
                <tr class="total-row" style="background-color: #f0f0f0; font-weight: bold;">
                  <td colspan="3" class="right"><strong>Total:</strong></td>
                  <td class="right"><strong>${{ getTotal() | number: '1.2-2' }}</strong></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="error" *ngIf="error">
          <span class="error-icon">‚ö†Ô∏è</span>
          {{ error }}
        </div>

        <!-- Cambiar Estado (solo si es BORRADOR o ENVIADA) -->
        <div class="cambiar-estado" *ngIf="cotizacionOriginal && (cotizacionOriginal.estado === 'BORRADOR' || cotizacionOriginal.estado === 'ENVIADA')">
          <h3>Cambiar Estado</h3>
          <div class="estado-controls">
            <select [(ngModel)]="nuevoEstado" name="nuevoEstado">
              <option [value]="null">Selecciona nuevo estado</option>
              <option *ngFor="let estado of estados" [value]="estado">
                {{ estado }}
              </option>
            </select>
          </div>
          <div class="estado-info">
            <p>üìù <strong>Nota:</strong> El cambio de estado se aplicar√° cuando guardes la cotizaci√≥n</p>
            <p>üì± <strong>ENVIADA:</strong> EL CLIENTE HA SIDO NOTIFICADO</p>
            <p>‚úÖ <strong>APROBADA:</strong> LISTA PARA EJECUTAR NEGOCIO</p>
            <p>‚ùå <strong>RECHAZADA:</strong> EL CLIENTE NO ESTA DEACUERDO CON LO ESTIPULADO</p>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="loading">
            {{ loading ? 'Guardando...' : 'Actualizar Cotizaci√≥n' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelar()" [disabled]="loading">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
