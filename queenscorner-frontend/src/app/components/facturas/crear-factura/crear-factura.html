<div class="crear-factura-container">
  <div class="header">
    <h1>Emitir Factura</h1>
    <button (click)="cancelar()" class="btn-cancel">← Volver</button>
  </div>

  <div *ngIf="success" class="alert alert-success">
    ✓ Factura creada exitosamente. Redirigiendo...
  </div>

  <div *ngIf="error" class="alert alert-error">
    ✗ {{ error }}
  </div>



  <form [formGroup]="form" (ngSubmit)="crearFactura()" class="form-container">
    <!-- SECCIÓN 1: DATOS BÁSICOS (NO EDITABLE si viene de queryParams) -->
    <div class="form-section" *ngIf="paso === 1 || !negocioSeleccionado">
      <h2>Información de la Factura a Emitir</h2>

      <!-- Si NO hay negocio seleccionado, mostrar selector -->
      <div *ngIf="!negocioSeleccionado" class="form-row">
        <div class="form-group">
          <label for="negocio">Negocio *</label>
          <select 
            id="negocio" 
            formControlName="negocioId"
            (change)="onNegocioChange(form.get('negocioId')?.value)"
            required>
            <option value="">-- Selecciona un negocio --</option>
            <option *ngFor="let negocio of negocios" [value]="negocio.id">
              {{ negocio.codigo }} - {{ negocio.cliente?.nombre }}
            </option>
          </select>
        </div>
      </div>

      <!-- Si hay negocio seleccionado, mostrar información NO EDITABLE -->
      <div *ngIf="negocioSeleccionado" class="negocio-info">
        <div class="info-box">
          <div class="info-row">
            <div class="info-group">
              <label>Negocio:</label>
              <p>{{ negocioSeleccionado.codigo }}</p>
            </div>
            <div class="info-group" *ngIf="negocioSeleccionado.cliente">
              <label>Cliente:</label>
              <p>{{ negocioSeleccionado.cliente?.nombre || 'N/A' }}</p>
            </div>
          </div>
          <div class="info-row" *ngIf="negocioSeleccionado.cliente">
            <div class="info-group">
              <label>Correo:</label>
              <p>{{ negocioSeleccionado.cliente.email || 'N/A' }}</p>
            </div>
            <div class="info-group">
              <label>Teléfono:</label>
              <p>{{ negocioSeleccionado.cliente.telefono || 'N/A' }}</p>
            </div>
          </div>
          <div class="info-row" *ngIf="negocioSeleccionado.cliente">
            <div class="info-group">
              <label>Dirección:</label>
              <p>{{ negocioSeleccionado.cliente.direccion || 'N/A' }}</p>
            </div>
            <div class="info-group">
              <label>Ciudad:</label>
              <p>{{ negocioSeleccionado.cliente.ciudad || 'N/A' }}</p>
            </div>
          </div>
          <div class="info-row">
            <div class="info-group">
              <label>Cotización:</label>
              <p>{{ cotizacion?.codigo || negocioSeleccionado.codigoCotizacion || 'Sin cotización' }}</p>
            </div>
            <div class="info-group">
              <label>Estado Cotización:</label>
              <p class="badge">{{ cotizacion?.estado || negocioSeleccionado.estadoCotizacion || 'N/A' }}</p>
            </div>
          </div>
          <!-- Mostrar totales desnormalizados si existen -->
          <div class="info-row" *ngIf="cotizacion?.total || negocioSeleccionado.totalCotizacion">
            <div class="info-group">
              <label>Subtotal Cotización:</label>
              <p>${{ cotizacion?.subtotal || negocioSeleccionado.subtotalCotizacion || 0 | number: '1.0-2' }}</p>
            </div>
            <div class="info-group">
              <label>IVA (19%):</label>
              <p>${{ cotizacion?.impuestos || negocioSeleccionado.impuestosCotizacion || 0 | number: '1.0-2' }}</p>
            </div>
            <div class="info-group">
              <label>Total:</label>
              <p><strong>${{ cotizacion?.total || negocioSeleccionado.totalCotizacion || 0 | number: '1.0-2' }}</strong></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Botón para continuar a Paso 2 (items) -->
      <div class="form-actions" *ngIf="negocioSeleccionado && paso === 1">
        <button 
          type="button"
          (click)="paso = 2"
          class="btn btn-primary">
          Continuar →
        </button>
      </div>
    </div>

    <!-- SECCIÓN 2: LÍNEAS DE FACTURA -->
    <div class="form-section" *ngIf="paso === 2 && negocioSeleccionado">
      <div class="section-header">
        <h2>Líneas de Factura</h2>
        <button type="button" (click)="agregarLinea()" class="btn-secondary">+ Agregar Línea</button>
      </div>

      <div class="table-container">
        <table class="lineas-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Valor Unitario</th>
              <th>Subtotal</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="lineas.length === 0">
              <td colspan="6" class="text-center">No hay líneas. Agrega una para continuar.</td>
            </tr>
            <tr *ngFor="let linea of lineas; let i = index">
              <td>{{ i + 1 }}</td>
              <td>
                <input 
                  type="text" 
                  [(ngModel)]="linea.descripcion"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Descripción del producto/servicio">
              </td>
              <td>
                <input 
                  type="number" 
                  [(ngModel)]="linea.cantidad"
                  [ngModelOptions]="{standalone: true}"
                  min="1"
                  class="input-numeric">
              </td>
              <td>
                <input 
                  type="number" 
                  [(ngModel)]="linea.valorUnitario"
                  [ngModelOptions]="{standalone: true}"
                  min="0"
                  step="0.01"
                  class="input-numeric">
              </td>
              <td class="value">$ {{ calcularValorLinea(linea) | number: '1.0-2' }}</td>
              <td>
                <button 
                  type="button" 
                  (click)="eliminarLinea(i)"
                  class="btn-delete">
                  Eliminar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- SECCIÓN 3: TOTALES -->
      <div class="form-section totales-section">
        <div class="totales-box">
          <div class="total-row">
            <span class="label">Subtotal:</span>
            <span class="value">$ {{ calcularSubtotal() | number: '1.0-2' }}</span>
          </div>
          <div class="total-row">
            <span class="label">IVA 19%:</span>
            <span class="value">$ {{ calcularIva() | number: '1.0-2' }}</span>
          </div>
          <div class="total-row total-final">
            <span class="label">TOTAL A PAGAR:</span>
            <span class="value">$ {{ calcularTotal() | number: '1.0-2' }}</span>
          </div>
        </div>
      </div>

      <!-- SECCIÓN 4: BOTONES DE ACCIÓN -->
      <div class="form-actions">
        <button 
          type="button" 
          (click)="paso = 1"
          class="btn btn-secondary"
          [disabled]="loading">
          ← Atrás
        </button>
        <button 
          type="button" 
          (click)="cancelar()"
          class="btn btn-secondary"
          [disabled]="loading">
          Cancelar
        </button>
        <button 
          type="submit"
          class="btn btn-primary"
          [disabled]="!negocioSeleccionado || lineas.length === 0 || loading">
          <span *ngIf="loading">Emitiendo...</span>
          <span *ngIf="!loading">✓ Emitir Factura</span>
        </button>
      </div>
    </div>
  </form>
</div>
