<div class="detail-container" *ngIf="!cargando; else loadingTemplate">
  <div class="detail-card">
    <!-- ENCABEZADO -->
    <div class="header">
      <div class="header-content">
        <h1>üíº Detalle del Negocio</h1>
        <p class="subtitle">C√≥digo: <strong>{{ negocio?.codigo }}</strong></p>
      </div>
      <button class="btn-volver" (click)="volver()">‚Üê Volver</button>
    </div>

    <!-- SECCI√ìN 1: COTIZACI√ìN ORIGEN (READ-ONLY) -->
    <div class="seccion read-only-section" *ngIf="negocio?.codigoCotizacion">
      <div class="section-header">
        <h3>üìù COTIZACI√ìN ORIGEN</h3>
        <span class="info-label">(Informaci√≥n de referencia)</span>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <label>C√≥digo Cotizaci√≥n</label>
          <p>{{ negocio?.codigoCotizacion }}</p>
        </div>
        <div class="info-item">
          <label>Estado Cotizaci√≥n</label>
          <p><span class="badge badge-info">{{ negocio?.estadoCotizacion }}</span></p>
        </div>
        <div class="info-item">
          <label>Fecha Cotizaci√≥n</label>
          <p>{{ formatearFecha(negocio?.fechaCotizacion) }}</p>
        </div>
        <div class="info-item">
          <label>Validez hasta</label>
          <p>{{ formatearFecha(negocio?.fechaValidezCotizacion) }}</p>
        </div>
        <div class="info-item">
          <label>Subtotal</label>
          <p>${{ negocio?.subtotalCotizacion | number:'1.2-2' }}</p>
        </div>
        <div class="info-item">
          <label>Impuestos</label>
          <p>${{ negocio?.impuestosCotizacion | number:'1.2-2' }}</p>
        </div>
        <div class="info-item">
          <label>Total Cotizaci√≥n</label>
          <p class="monto">${{ negocio?.totalCotizacion | number:'1.2-2' }}</p>
        </div>
      </div>

      <div *ngIf="negocio?.descripcionCotizacion" class="info-section">
        <label>Descripci√≥n Cotizaci√≥n</label>
        <p>{{ negocio?.descripcionCotizacion }}</p>
      </div>

      <div *ngIf="negocio?.observacionesCotizacion" class="info-section">
        <label>Observaciones Cotizaci√≥n</label>
        <p>{{ negocio?.observacionesCotizacion }}</p>
      </div>
    </div>

    <!-- SECCI√ìN 2: DATOS DEL NEGOCIO -->
    <div class="seccion editable-section">
      <div class="section-header">
        <h3>üíº DATOS DEL NEGOCIO</h3>
        <span class="info-label">(Informaci√≥n de negocio)</span>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <label>Cliente</label>
          <p>{{ negocio?.cliente?.nombre }}</p>
        </div>
        <div class="info-item">
          <label>Estado</label>
          <p>
            <span class="badge" 
                  [style.background-color]="getEstadoColor(negocio?.estado || '')"
                  [style.color]="getEstadoTextColor(negocio?.estado || '')">
              {{ negocio?.estado }}
            </span>
          </p>
        </div>
        <div class="info-item">
          <label>Presupuesto Asignado</label>
          <p class="monto">${{ negocio?.presupuestoAsignado | number:'1.2-2' }}</p>
        </div>
        <div class="info-item">
          <label>Anticipo</label>
          <p>${{ negocio?.anticipo | number:'1.2-2' }}</p>
        </div>
        <div class="info-item">
          <label>Disponible</label>
          <p [ngClass]="{'warning': (negocio?.presupuestoAsignado! - (negocio?.anticipo || 0)) < 0}">
            ${{ (negocio?.presupuestoAsignado || 0) - (negocio?.anticipo || 0) | number:'1.2-2' }}
          </p>
        </div>
        <div class="info-item">
          <label>Responsable</label>
          <p>{{ negocio?.responsable || '-' }}</p>
        </div>
        <div class="info-item">
          <label>Fecha Inicio</label>
          <p>{{ formatearFecha(negocio?.fechaInicio) }}</p>
        </div>
        <div class="info-item">
          <label>Fecha Fin Estimada</label>
          <p>{{ formatearFecha(negocio?.fechaFinEstimada) }}</p>
        </div>
        <div class="info-item">
          <label>Creado</label>
          <p>{{ formatearFecha(negocio?.fechaCreacion) }}</p>
        </div>
        <div class="info-item">
          <label>√öltima actualizaci√≥n</label>
          <p>{{ formatearFecha(negocio?.fechaActualizacion) }}</p>
        </div>
      </div>

      <div *ngIf="negocio?.descripcion" class="info-section">
        <label>Descripci√≥n</label>
        <p>{{ negocio?.descripcion }}</p>
      </div>

      <div *ngIf="negocio?.observaciones" class="info-section">
        <label>Observaciones</label>
        <p>{{ negocio?.observaciones }}</p>
      </div>
    </div>

    <!-- CAMBIO DE ESTADO -->
    <div class="seccion">
      <div class="cambio-estado-container">
        <button class="btn-cambiar-estado" 
                (click)="toggleCambioEstado()"
                [disabled]="obtenerTransicionesValidas().length === 0">
          {{ mostrarCambioEstado ? '‚úï Cancelar' : '‚öôÔ∏è Cambiar Estado' }}
        </button>

        <div *ngIf="mostrarCambioEstado" class="cambio-estado-form">
          <select [(ngModel)]="nuevoEstado" class="select-estado">
            <option value="">-- Seleccionar estado --</option>
            <option *ngFor="let estado of obtenerTransicionesValidas()" [value]="estado">
              {{ estado }}
            </option>
          </select>
          <button class="btn-guardar" 
                  (click)="guardarCambioEstado()"
                  [disabled]="procesando || !nuevoEstado">
            {{ procesando ? 'Guardando...' : 'Guardar Cambio' }}
          </button>
        </div>
      </div>
    </div>

    <!-- ACCIONES -->
    <div class="acciones">
      <button class="btn-primary" (click)="editar()" 
              [disabled]="negocio?.estado === 'FINALIZADO' || negocio?.estado === 'CANCELADO'">
        ‚úèÔ∏è Editar Negocio
      </button>
      <button class="btn-success" (click)="crearOrden()" 
              [disabled]="negocio?.estado !== 'FINALIZADO'">
        üìã Crear Orden de Trabajo
      </button>
    </div>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="loading-center">
    <div class="spinner"></div>
    <p>Cargando negocio...</p>
  </div>
</ng-template>
