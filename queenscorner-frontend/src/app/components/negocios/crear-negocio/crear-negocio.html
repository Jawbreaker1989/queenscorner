<div class="form-container">
  <div class="form-card">
    <div *ngIf="cargando" class="loading-center">
      <div class="spinner"></div>
      <p>Cargando cotizaciones...</p>
    </div>

    <div *ngIf="!cargando">
      <h1>üìã Crear Negocio desde Cotizaci√≥n</h1>
      <p class="subtitle">Genera un nuevo negocio a partir de una cotizaci√≥n aprobada</p>

      <!-- SECCI√ìN: Seleccionar Cotizaci√≥n Aprobada -->
      <div *ngIf="!cotizacionSeleccionada" class="seccion selection-section">
        <div class="section-header">
          <h3>‚úì SELECCIONAR COTIZACI√ìN APROBADA</h3>
          <span class="info-label">(Paso 1 de 2)</span>
        </div>

        <div *ngIf="error" class="error-message">
          <span class="error-icon">‚ö†Ô∏è</span>
          {{ error }}
        </div>

        <div *ngIf="cotizacionesAprobadas.length > 0" class="cotizaciones-grid">
          <div
            *ngFor="let cot of cotizacionesAprobadas"
            class="cotizacion-card"
            (click)="seleccionarCotizacion(cot.id)">
            <div class="cotizacion-header">
              <h4>{{ cot.codigo }}</h4>
              <span class="badge badge-success">{{ cot.estado }}</span>
            </div>
            <div class="cotizacion-info">
              <p><strong>Cliente:</strong> {{ cot.cliente.nombre }}</p>
              <p><strong>Descripci√≥n:</strong> {{ cot.descripcion }}</p>
              <p class="monto"><strong>Total:</strong> ${{ cot.total | number: '1.2-2' }}</p>
            </div>
            <div class="cotizacion-footer">
              <small>Haz clic para seleccionar</small>
            </div>
          </div>
        </div>

        <div *ngIf="cotizacionesAprobadas.length === 0" class="empty-state">
          <p>üì≠ No hay cotizaciones aprobadas disponibles</p>
          <button type="button" class="btn btn-secondary" (click)="cancelar()">
            Volver a Cotizaciones
          </button>
        </div>
      </div>

      <!-- SECCI√ìN: Formulario de Negocio (visible solo despu√©s de seleccionar cotizaci√≥n) -->
      <form *ngIf="cotizacionSeleccionada" (ngSubmit)="guardar()" class="formulario">
        <!-- SECCI√ìN 1: Informaci√≥n de la Cotizaci√≥n (READ-ONLY) -->
        <div class="seccion read-only-section">
          <div class="section-header">
            <h3>üìù COTIZACI√ìN ORIGEN</h3>
            <span class="info-label">(Informaci√≥n de referencia)</span>
          </div>

          <div *ngIf="cotizacion" class="info-grid">
            <div class="info-item">
              <label>C√≥digo</label>
              <p class="value">{{ cotizacion.codigo }}</p>
            </div>
            <div class="info-item">
              <label>Cliente</label>
              <p class="value">{{ cotizacion.cliente.nombre }}</p>
            </div>
            <div class="info-item">
              <label>Subtotal</label>
              <p class="value">${{ cotizacion.subtotal | number: '1.2-2' }}</p>
            </div>
            <div class="info-item">
              <label>Impuestos</label>
              <p class="value">${{ cotizacion.impuestos | number: '1.2-2' }}</p>
            </div>
            <div class="info-item">
              <label>Total</label>
              <p class="value monto">${{ cotizacion.total | number: '1.2-2' }}</p>
            </div>
            <div class="info-item">
              <label>Estado</label>
              <p><span class="badge badge-success">{{ cotizacion.estado }}</span></p>
            </div>
          </div>

          <div *ngIf="cotizacion && cotizacion.descripcion" class="info-section">
            <label>Descripci√≥n</label>
            <p class="value">{{ cotizacion.descripcion }}</p>
          </div>

          <div class="select-other-btn">
            <button type="button" class="btn btn-link" (click)="cambiarCotizacion()">
              ‚Ü™Ô∏è Seleccionar otra cotizaci√≥n
            </button>
          </div>
        </div>

        <!-- SECCI√ìN 2: Datos del Negocio (EDITABLES) -->
        <div class="seccion editable-section">
          <div class="section-header">
            <h3>üíº DATOS DEL NEGOCIO</h3>
            <span class="info-label">(Paso 2 de 2 - Informaci√≥n a completar)</span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="fechaInicio">Fecha Inicio *</label>
              <input
                type="date"
                id="fechaInicio"
                [(ngModel)]="negocio.fechaInicio"
                name="fechaInicio"
                [disabled]="loading"
                required />
            </div>

            <div class="form-group">
              <label for="fechaFinEstimada">Fecha Fin Estimada *</label>
              <input
                type="date"
                id="fechaFinEstimada"
                [(ngModel)]="negocio.fechaFinEstimada"
                name="fechaFinEstimada"
                [disabled]="loading"
                required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="presupuestoAsignado">Presupuesto Asignado</label>
              <input
                type="number"
                id="presupuestoAsignado"
                [(ngModel)]="negocio.presupuestoAsignado"
                name="presupuestoAsignado"
                placeholder="Monto del presupuesto asignado"
                step="0.01"
                [disabled]="loading"
                min="0" />
              <small>Presupuesto disponible para el negocio</small>
            </div>

            <div class="form-group">
              <label for="anticipo">Anticipo Otorgado</label>
              <input
                type="number"
                id="anticipo"
                [(ngModel)]="negocio.anticipo"
                name="anticipo"
                placeholder="0.00"
                step="0.01"
                [disabled]="loading"
                min="0"
                value="0" />
              <small>Anticipo recibido por la cotizaci√≥n aprobada</small>
            </div>

            <div class="form-group">
              <label for="saldoPendiente">Saldo Pendiente</label>
              <input
                type="number"
                id="saldoPendiente"
                [value]="(cotizacion?.total || 0) - (negocio.anticipo || 0)"
                name="saldoPendiente"
                step="0.01"
                disabled
                readonly />
              <small>Monto pendiente (total cotizaci√≥n - anticipo)</small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="responsable">Responsable</label>
              <input
                type="text"
                id="responsable"
                [(ngModel)]="negocio.responsable"
                name="responsable"
                placeholder="Nombre del responsable"
                [disabled]="loading" />
            </div>
          </div>

          <div class="form-group">
            <label for="descripcion">Descripci√≥n del Negocio *</label>
            <textarea
              id="descripcion"
              [(ngModel)]="negocio.descripcion"
              name="descripcion"
              placeholder="Describe el negocio a realizar"
              rows="3"
              [disabled]="loading"
              required></textarea>
            <small>Esta informaci√≥n se utilizar√° para documentar el prop√≥sito del negocio</small>
          </div>

          <div class="form-group">
            <label for="observaciones">Observaciones</label>
            <textarea
              id="observaciones"
              [(ngModel)]="negocio.observaciones"
              name="observaciones"
              placeholder="Notas adicionales (opcional)"
              rows="2"
              [disabled]="loading"></textarea>
          </div>
        </div>

        <!-- Mensajes de Error -->
        <div class="error" *ngIf="error">
          <span class="error-icon">‚ö†Ô∏è</span>
          {{ error }}
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="loading">
            <span *ngIf="!loading">‚úì Crear Negocio</span>
            <span *ngIf="loading">‚è≥ Creando...</span>
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelar()" [disabled]="loading">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
