<div class="form-container" *ngIf="!cargando; else loadingTemplate">
  <div class="form-card">
    <h1>Editar Orden de Trabajo</h1>
    <p class="subtitle">Modifique los datos de la orden {{ orden?.codigo }}</p>

    <div *ngIf="orden" class="formulario">
      <div class="seccion">
        <h3>Informaci√≥n de la Orden</h3>
        <div class="info-box">
          <div class="info-item">
            <label>C√≥digo</label>
            <p>{{ orden.codigo }}</p>
          </div>
          <div class="info-item">
            <label>Cliente</label>
            <p>{{ orden.cliente.nombre }}</p>
          </div>
          <div class="info-item">
            <label>Estado</label>
            <p>{{ orden.estado }}</p>
          </div>
        </div>
      </div>

      <div class="seccion">
        <h3>Editar Datos</h3>
        <div class="form-group">
          <label for="descripcion">Descripci√≥n *</label>
          <textarea id="descripcion" 
                    [(ngModel)]="ordenForm.descripcion" 
                    placeholder="Describa la orden de trabajo"
                    rows="4"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="fechaInicio">Fecha Inicio *</label>
            <input type="date" 
                   id="fechaInicio" 
                   [(ngModel)]="ordenForm.fechaInicio">
          </div>

          <div class="form-group">
            <label for="fechaFin">Fecha Estimada Fin</label>
            <input type="date" 
                   id="fechaFin" 
                   [(ngModel)]="ordenForm.fechaEstimadaFin">
          </div>
        </div>

        <div class="form-group">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones" 
                    [(ngModel)]="ordenForm.observaciones" 
                    placeholder="Agregue observaciones (opcional)"
                    rows="3"></textarea>
        </div>
      </div>

      <div class="seccion">
        <div class="seccion-header">
          <h3>Detalles de la Orden</h3>
          <button class="btn-agregar" (click)="toggleFormDetalle()" type="button">
            {{ mostrarFormDetalle ? '‚úï Cancelar' : '‚úö Agregar Detalle' }}
          </button>
        </div>

        <div *ngIf="mostrarFormDetalle" class="formulario-detalle">
          <div class="form-group">
            <label for="descDetalle">Descripci√≥n *</label>
            <input type="text" 
                   id="descDetalle" 
                   [(ngModel)]="nuevoDetalle.descripcion" 
                   placeholder="Describa el detalle del trabajo">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="cantidad">Cantidad *</label>
              <input type="number" 
                     id="cantidad" 
                     [(ngModel)]="nuevoDetalle.cantidad" 
                     min="1"
                     step="1">
            </div>

            <div class="form-group">
              <label for="precio">Precio Unitario *</label>
              <input type="number" 
                     id="precio" 
                     [(ngModel)]="nuevoDetalle.precioUnitario" 
                     min="0"
                     step="0.01">
            </div>
          </div>

          <button class="btn-guardar-detalle" (click)="agregarDetalle()" type="button">
            Agregar Detalle
          </button>
        </div>

        <div *ngIf="detalles.length > 0" class="detalles-table-wrapper">
          <table class="detalles-table">
            <thead>
              <tr>
                <th>Descripci√≥n</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let detalle of detalles; let i = index">
                <td>{{ detalle.descripcion }}</td>
                <td>{{ detalle.cantidad }}</td>
                <td>${{ detalle.precioUnitario | number:'1.2-2' }}</td>
                <td>${{ (detalle.subtotal || 0) | number:'1.2-2' }}</td>
                <td>
                  <button class="btn-eliminar" (click)="eliminarDetalle(i)" type="button" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="totales">
            <div class="total-item">
              <span>Subtotal:</span>
              <span>${{ subtotal | number:'1.2-2' }}</span>
            </div>
            <div class="total-item">
              <span>Impuestos (19%):</span>
              <span>${{ impuestos | number:'1.2-2' }}</span>
            </div>
            <div class="total-item total-final">
              <span>Total:</span>
              <span>${{ total | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-secondary" (click)="cancelar()" [disabled]="procesando" type="button">
          Cancelar
        </button>
        <button class="btn btn-primary" (click)="guardar()" [disabled]="procesando || detalles.length === 0" type="button">
          {{ procesando ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="loading-center">
    <div class="spinner"></div>
    <p>Cargando orden...</p>
  </div>
</ng-template>
